## 红黑树

### 平衡树

红黑树的本质其实也是对概念模型：**2-3-4树**的一种实现，因此我们先来关注2-3-4树。

2-3-4树是**阶数**为4的B树，B树，全名BalanceTree，平衡树。这种结构主要用来做查找。

关于B树（**平衡多路查找树**）的定义，网上已经有很多介绍，在此不多赘述。它最重要的特性在于平衡，这使得我们能够在最坏情况下也保持O(LogN)的时间复杂度实现查找（一个不具备平衡性的查找树可能退化成单链表，时间复杂度会到O（N））。

==平衡的定义是说从空链接到根节点距离相等，此处一定要用心理解。（也就是说非叶子节点是不会存在空链接的）==

由于2-3-4树是一颗阶数为4的B树，所以它会存在以下节点：

- 2节点
- 3节点
- 4节点

2节点中存放着一个key[X]，两个指针，分别指向小于X的子节点和大于X的子节点；3节点中存放在两个key[X,Y],三个指针，分别指向小于X的子节点，介于X~Y之间的子节点和大于Y的子节点；4节点可依此类推。

![image-20201105092500492](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20201105092500492.png)

### 2-3-4树到红黑树的转化

红黑树是对概念模型2-3-4树的一种实现，由于直接进行不同节点间的转化会造成较大的开销，所以选择以二叉树为基础，在二叉树的属性中加入一个**颜色属性**来表示2-3-4树中不同的节点。

2-3-4树中的2节点对应着红黑树中的黑色节点，而2-3-4树中的非2节点是以**红节点+黑节点**的方式存在，红节点的意义是与黑色父节点结合，表达着2-3-4树中的3，4节点。

（此处理解成红节点也好，红色链接也好，看个人喜好。很多书中会说是由黑色节点指出的红色链接，链接指向的节点颜色为红。）

我们先看2-3-4树到红黑树的节点转换。2节点直接转化为黑色节点；3节点这里可以有两种表现形式，左倾红节点或者右倾红节点。而4节点被强制**要求**转化为一个黑父带着左右两个红色儿子。

![image-20201105092629456](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20201105092629456.png)

![image-20201105092824721](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20201105092824721.png)

![image-20201105093045486](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20201105093045486.png)

选择算法4中的红黑树做演示主体。

- 首先，算法4中的红黑树基于2-3树概念模型，不用考虑2-3-4树中复杂的**4节点分裂**；
- 第二，算法4中的红黑树是**左倾红黑树**，进一步降低了调平的难度；
- 第三，算法导论中对于红黑树删除场景的阐述并**不够具体**，许多关键环节都用“经过一定的旋转和变色处理”来带过，不利于新手的学习。

我们在了解红黑树的插入删除操作之前，需要先了解2-3树的插入删除操作，这样才能理解红黑树中染色和旋转背后的意义。

让我们来看一下对于2-3树的插入。我们的插入操作需要遵循一个**原则**：==先将这个元素尝试性地放在**已经存在的节点中**，如果要存放的节点是2节点，那么插入后会变成3节点，如果要存放的节点是3节点，那么插入后会变成4节点（**临时**）。然后，我们对可能生成的临时4节点进行分裂处理，使得临时4节点消失==。

![image-20201105093927312](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20201105093927312.png)

![image-20201105094003055](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20201105094003055.png)

事实上，这正对应了红黑树在插入的时候一定会把待插入节点涂成红色，因为红色节点的意义是**与父节点进行关联**，形成概念模型2-3树中的3节点或者临时4节点。

而红黑树之所以需要在插入后进行调整，正是因为可能存在着**概念模型中的临时4节点**（反应在红黑树中是双红的情况）。

试想在2-3树中如果待插入节点是个2节点，那么反应在红黑树中，不正好对应着黑色父节点吗，在黑色父节点下面增加一个红色儿子，确实不会违背红黑树的任何规则，这也对应着我们向2-3树中的2节点插入一个元素，只需要简单的把2节点变成3节点。

接下来让我们来看一下对于2-3树的删除。对于2-3树的删除我们主要要考虑待删除元素在2节点这种情况，因为如果待删除元素在3节点，那么可以直接将这个元素删除，而不会破坏2-3树的任何性质（删除这个元素不会引起高度的变化）。

当待删除元素在2节点的时候，由于删除这个元素会导致2节点失去自己**唯一的元素**，引发2节点自身的删除，会使得树中某条路径的高度发生变化，树变得**不平衡**。

因此我们有两种方案去解决这个问题：

- 第一种方案，先删除这个2节点，然后对树进行平衡调整。
- 第二种方案，我们想办法让这个被删除的元素不可能出现在2节点中。

本文选择第二种方案，我们在搜索到这个节点的路径中，不断地判断当前节点是否为2节点，如果是，就从它的兄弟节点或者它的父节点借一个元素，使得当前节点由2节点成为一个3节点或者一个临时4节点（视具体情况而定，在后面的红黑树部分会详细介绍）。

这种操作会产生一种结果：**除非当前节点是根节点，否则当前节点的父节点一定是一个非2节点**（因为搜索的路径是自上而下，父节点已经进行过了这种操作，所以不可能是2节点），那么我们可以保证到达叶子节点的时候，也能顺利的从父节点或者兄弟节点处借到元素，使得自己成为非2节点。从而能够直接删除某个元素（现在这个元素不在2节点中了）。

![image-20201105094710223](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20201105094710223.png)

![image-20201105094756170](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20201105094756170.png)

![image-20201105095210730](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20201105095210730.png)

### 红黑树

来看它的五条定义：

1.节点颜色有红色和黑色

2.根节点必为黑色

【2-3树中如果根节点为2节点，那么它本来就对应红黑树中黑节点；如果根节点为3节点，也可以用黑色节点表示较大的那个元素，然后较小的元素作为左倾红节点存在于红黑树中】

3.所有叶子节点都是黑色

【此处提到的叶子其实是空链接】

4.任意节点到叶子节点经过的黑色节点数目相同

【红黑树中的红节点是和黑色父节点绑定的，在2-3树中本来就是同一层的，只有黑色节点才会在2-3树中真正**贡献高度**，由于2-3树的任一节点到空链接距离相同，因此反应在红黑树中就是**黑色完美平衡**】

5.不会有连续的红色节点

【2-3树中本来就规定没有4节点，2-3-4树中虽然有4节点，但是要求在红黑树中体现为一黑色节点带两红色儿子，分布左右，所以也不会有连续红节点】

### 树的旋转

旋转是二叉树调平的精髓。

![image-20201105095447638](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20201105095447638.png)

![image-20201105095551901](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20201105095551901.png)

如图所示，对于左倾红黑树的插入一共有三种可能的情况。

- 第一种，待插入元素比黑父大，插在了黑父的右边，而黑父左边是红色儿子。这种情况会导致在红黑树中出现右倾红节点。

  注意，这种情况对应着2-3树中出现了**临时4节点**，我们在2-3树中的处理是将这个临时4节点分裂，左右元素各自形成一个2节点，中间元素**上升**到上层跟父节点结合。所以，我们在红黑树中的动作是，将原本红色的左右儿子染黑（左右分裂），将黑父染红（等待上升结合）。

  ![img](https://mmbiz.qpic.cn/mmbiz_jpg/uChmeeX1FpxUsRkl0qWWJlpMZxrACBXKKeybqDZXoc8u0Ktv9icTzeK6D75MIl24P0RZGxic0Zzib9ayIia45fBhPg/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)左倾红黑树的插入

- 第二种情况，待插入元素比红父小，且红父自身就是左倾。听起来有点绕，看图就会明白，其实就是说红父和待插入元素**同时靠在了左边**，形成了连续的红节点。

  这种情况我们需要用两步来调整。由于我们插入的是红色节点，其实不会破坏黑色完美平衡，所以要注意的是在旋转和染色的过程种继续保持这种**完美黑色平衡**。

  首先对红父的父亲进行一次右旋，这次右旋不会破坏黑色平衡，但是也没有解决连续红色的问题。

  接下来将12所在节点与15所在节点交换颜色，这样的目的是为了消除连续红色，并且这个操作依旧维持了黑色平衡。现在我们已经得到了情况1的场景，直接按**情况1**处理即可。

  ![img](https://mmbiz.qpic.cn/mmbiz_jpg/uChmeeX1FpxUsRkl0qWWJlpMZxrACBXKBle0yqItPKVzuAQSUSKoKAteeETYh2OJeicnCDhn1Yd3XZ4GXQRhJ9A/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)左倾红黑树的插入

- 第三种情况，待插入元素比红父大，且红父自身就是左倾。

  也就是说插入的这个节点形成了一个右倾的红色节点，对**右倾**的处理很简单，将红父进行一次左旋，就能使得右倾红节点变为左倾，现在出现了连续的左倾红节点，直接按**情况2**处理即可。

  ![img](https://mmbiz.qpic.cn/mmbiz_jpg/uChmeeX1FpxUsRkl0qWWJlpMZxrACBXKUtibSXjokGHJerqXWkOvlYhueIMIZa5POZDmGS3m9HeQ4cFfLFibcg7Q/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)左倾红黑树的插入

在插入时，可以体会到左倾红黑树对于左倾的限制带来的好处，因为在原树符合红黑树定义的情况下，如果父亲是红的，那么它**一定左倾**，同时也不用考虑可能存在的右倾兄弟（如果有，那说明**原树不满足红黑树定义**）。

这种限制消除了很多需要考虑的场景，让插入变得更加简单。

### 左倾红黑树的删除

左倾红黑树的删除需要借鉴上文中提到的**二叉查找树通用的删除策略**，当我们要删除某个节点的时候选择它的前驱节点或者后继节点元素来**替代**它，转而删除它的前驱/后继节点。

在这个例子中，我选择用后继节点来替代被删除节点。

假设我们需要删除的节点它的右子树如图所示，那么对该节点的删除实际上转为了对2的删除。

我们从当前的根节点出发，利于2-3树中预合并的策略逐层对红黑树进行调整。具体的做法是，每次都保证当前的节点是2-3树中的非2节点，如果当前节点已经是非2节点，那么直接跳过；如果当前节点是2节点，那么根据兄弟节点的状况来进行调整：

- 如果兄弟是2节点，那么从父节点借一个元素给当前节点，然后与兄弟节点一起形成一个临时4节点。
- 如果兄弟是非2节点，那么兄弟上升一个元素到父节点，同时父节点下降一个元素到当前节点，使得当前节点成为一个3节点。

这样的策略能够保证最后走到待删除节点的时候，它一定是一个非2节点，我们可以直接将其元素删除。

![img](https://mmbiz.qpic.cn/mmbiz_jpg/uChmeeX1FpxUsRkl0qWWJlpMZxrACBXKUSn0H6OxHQlVIAc9iaQvickNTG1JwT5lGs63YU64dkQE1BP89HNBaibIA/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)左倾红黑树的删除

接下来要考虑的是**修复工作**，由于红黑树定义的限制，我们在调整的过程中出现了一些本不该存在的**红色右倾节点**（因为生成了概念模型中的临时4节点），于是我们顺着搜索的方向向上**回溯**，如果遇到当前节点具备右倾的红色儿子，那么对当前节点进行一次左旋，这时原本的右儿子会来到当前节点的位置，然后将右儿子与当前节点交换颜色，我们就将右倾红节点修复成了左倾红节点，同时我们并没有破坏黑色节点的平衡。

![img](https://mmbiz.qpic.cn/mmbiz_jpg/uChmeeX1FpxUsRkl0qWWJlpMZxrACBXKdHXQUB7ybo5Nm7lcicDgItBaZMpJ7WDHdvmgLacU0vkeqKrYFCYYYTQ/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)左倾红黑树的删除

右倾转左倾是一个很基本的操作，我们以35，44为例，你既可以将35作为黑节点，44作为右倾红色儿子；也可以将44作为黑节点，35作为左倾红儿子。事实上我们对于右倾的修复就是换了一种**树形**而已。一路回溯到当前根节点，直至路径中不再包含**任何**的红色右倾节点，至此修复工作全部完成。